<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Arena RPG Market</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Crimson+Text:wght@400;600&display=swap');
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #13131a;
            --bg-card: #1a1a24;
            --accent-gold: #d4af37;
            --accent-amber: #ff9500;
            --text-primary: #e8e6e3;
            --text-secondary: #a8a6a3;
            --text-muted: #6b6966;
            --border: #2a2a34;
            --shadow: rgba(212, 175, 55, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 149, 0, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .header {
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            letter-spacing: 0.05em;
        }
        
        .filter-section-title {
            margin-bottom: 1rem;
            animation: fadeInDown 0.8s ease-out;
        }
        
        .filter-section-title h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .filter-section-title p {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .filters {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-amber));
            border: none;
            border-radius: 6px;
            padding: 0.75rem 2rem;
            color: var(--bg-primary);
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: end;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .stats-bar {
            display: flex;
            gap: 2rem;
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease-out 0.3s both;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-value {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-gold);
        }
        
        .listings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .listing-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 70px 180px 140px 120px 160px 220px;
            gap: 1.5rem;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out both;
        }
        
        .listing-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent-gold);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .listing-card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 8px 32px var(--shadow);
            transform: translateX(4px);
        }
        
        .listing-card:hover::before {
            transform: scaleY(1);
        }
        
        .listing-card:nth-child(n) {
            animation-delay: calc(0.05s * (var(--index, 1)));
        }
        
        .card-id {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }
        
        .card-user {
            display: flex;
            flex-direction: column;
        }
        
        .username {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .item-name {
            font-size: 0.85rem;
            color: var(--accent-gold);
            font-style: italic;
            margin-bottom: 0.15rem;
        }
        
        .item-type {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }
        
        .card-slot {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .slot-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .slot-name {
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .card-power {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .power-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        .power-value {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-amber);
        }
        
        .card-costs {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .cost-line {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .cost-icon {
            font-size: 1rem;
        }
        
        .card-extras {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--accent-gold);
            white-space: nowrap;
        }
        
        .card-dates {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .date-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .date-label {
            color: var(--text-muted);
            min-width: 50px;
        }
        
        .date-value {
            color: var(--text-secondary);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 2rem 0;
        }
        
        .page-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover:not(:disabled) {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }
        
        .page-btn.active {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 4rem 0;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: spin 1s linear infinite;
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: #fca5a5;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 1400px) {
            .listing-card {
                grid-template-columns: 60px 160px 120px 110px 150px 200px;
                gap: 1rem;
                padding: 1.25rem;
                font-size: 0.95rem;
            }
            
            h1 {
                font-size: 2.5rem;
            }
        }
        
        @media (max-width: 1200px) {
            .listing-card {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .card-id {
                text-align: left;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Market</h1>
            <p class="subtitle">Stream Arena RPG - Browse items from adventurers across the realm</p>
        </div>
        
        <!-- Filters Section -->
        <div class="filter-section-title">
            <h2>üîç Filters</h2>
            <p>All listings are loaded automatically - filter them instantly below</p>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Item Name</label>
                <select id="filterItemName">
                    <option value="">Any Item</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Slot</label>
                <select id="filterSlot">
                    <option value="">All Slots</option>
                    <option value="weapon">Weapon</option>
                    <option value="off_hand">Off-Hand</option>
                    <option value="head">Head</option>
                    <option value="body">Body</option>
                    <option value="hands">Hands</option>
                    <option value="feet">Feet</option>
                    <option value="neck">Neck</option>
                    <option value="ring">Ring</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Class</label>
                <select id="filterItemClass">
                    <option value="">Any Class</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Username</label>
                <input type="text" id="filterUsername" placeholder="Filter by username...">
            </div>
            
            <div class="filter-group">
                <label>Min Power %</label>
                <input type="number" id="filterMinPower" placeholder="0" step="0.1">
            </div>
            
            <div class="filter-group">
                <label>Max Power %</label>
                <input type="number" id="filterMaxPower" placeholder="999" step="0.1">
            </div>
        </div>
        
        <div class="filters" style="animation-delay: 0.3s;">
            <div class="filter-group">
                <label>Min Range</label>
                <input type="number" id="filterMinRange" placeholder="Any" min="0">
            </div>
            
            <div class="filter-group">
                <label>Max Range</label>
                <input type="number" id="filterMaxRange" placeholder="Any" min="0">
            </div>
            
            <div class="filter-group">
                <label>Extra Property</label>
                <select id="filterExtraProperty">
                    <option value="">Any</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Max Platinum</label>
                <input type="number" id="filterMaxPlatinum" placeholder="No limit" min="0">
            </div>
            
            <div class="filter-group">
                <label>Max Gold</label>
                <input type="number" id="filterMaxGold" placeholder="No limit" step="1000" min="0">
            </div>
            
            <div class="filter-group">
                <label>Max Gems</label>
                <input type="number" id="filterMaxGems" placeholder="No limit" min="0">
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn" onclick="applyFilters()" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);">‚ú® Apply Filters</button>
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn" onclick="clearFilters()" style="background: linear-gradient(135deg, #ef4444, #dc2626);">üóëÔ∏è Clear Filters</button>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat">
                <span class="stat-label">Status</span>
                <span class="stat-value" id="statusText">Loading...</span>
            </div>
            <div class="stat">
                <span class="stat-label">Total Listings</span>
                <span class="stat-value" id="totalCount">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Showing</span>
                <span class="stat-value" id="showingCount">0</span>
            </div>
        </div>
        
        <div class="listings" id="listings">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading market listings...</p>
            </div>
        </div>
    </div>
    
    <script>
        const slotIcons = {
            'weapon': '‚öîÔ∏è',
            'off_hand': 'üõ°Ô∏è',
            'body': 'üõ°Ô∏è',
            'head': 'üëë',
            'hands': 'üß§',
            'feet': 'üë¢',
            'neck': 'üìø',
            'ring': 'üíç'
        };
        
        let currentData = null;
        let allListings = []; // Store all loaded listings for client-side filtering
        let gameItems = null; // Store game items data
        
        // Load game items data on page load
        async function loadGameItems() {
            console.log('  ‚Üí Fetching /api/items...');
            
            try {
                const response = await fetch('/api/items');
                console.log('  ‚Üí Response status:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('  ‚Üí Response data:', data);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || 'Unknown error'}`);
                }
                
                if (data.status !== 'success') {
                    throw new Error(`API returned status: ${data.status}`);
                }
                
                if (!data.items || !Array.isArray(data.items)) {
                    throw new Error('API response missing items array');
                }
                
                gameItems = data.items;
                console.log('  ‚Üí Successfully loaded', gameItems.length, 'items');
                
                if (gameItems.length > 0) {
                    console.log('  ‚Üí Sample item:', JSON.stringify(gameItems[0], null, 2));
                }
                
                return true;
                
            } catch (error) {
                console.error('  ‚úó ERROR loading game items:', error);
                gameItems = null;
                throw error;
            }
        }
        
        // Populate all filters from game items
        function populateFilters() {
            console.log('  ‚Üí populateFilters called');
            
            if (!gameItems || gameItems.length === 0) {
                console.error('  ‚úó Cannot populate filters - gameItems is null or empty!');
                return false;
            }
            
            console.log('  ‚Üí gameItems available:', gameItems.length, 'items');
            
            populateItemNameFilter();
            populateItemClassFilter();
            populateExtraPropertyFilter();
            
            return true;
        }
        
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Add real-time filtering on Enter key
            ['filterUsername', 'filterMinPower', 'filterMaxPower', 'filterMinRange', 'filterMaxRange', 
             'filterMaxPlatinum', 'filterMaxGold', 'filterMaxGems'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') applyFilters();
                    });
                }
            });
            
            // Add change listeners for select dropdowns
            ['filterItemName', 'filterSlot', 'filterItemClass', 'filterExtraProperty'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', applyFilters);
                }
            });
            
            console.log('Event listeners setup complete');
        }
        
        // Populate item name filter
        function populateItemNameFilter() {
            console.log('    ‚Üí Populating Item Name filter...');
            
            const itemNameFilter = document.getElementById('filterItemName');
            if (!itemNameFilter) {
                console.error('    ‚úó filterItemName element not found!');
                return;
            }
            
            itemNameFilter.innerHTML = '<option value="">Any Item</option>';
            
            // Group by slot and sort
            const itemsBySlot = {};
            gameItems.forEach(item => {
                if (!itemsBySlot[item.slot]) {
                    itemsBySlot[item.slot] = [];
                }
                itemsBySlot[item.slot].push(item);
            });
            
            // Add optgroups by slot
            let totalItems = 0;
            Object.keys(itemsBySlot).sort().forEach(slot => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = formatSlotName(slot);
                
                itemsBySlot[slot].sort((a, b) => a.item_name.localeCompare(b.item_name)).forEach(item => {
                    const option = document.createElement('option');
                    option.value = `${item.id}:${item.slot}`;
                    option.textContent = item.item_name;
                    optgroup.appendChild(option);
                    totalItems++;
                });
                
                itemNameFilter.appendChild(optgroup);
            });
            
            console.log('    ‚úì Item Name filter:', totalItems, 'items in', Object.keys(itemsBySlot).length, 'slots');
        }
        
        // Populate item class filter
        function populateItemClassFilter() {
            console.log('    ‚Üí Populating Class filter...');
            
            const itemClassFilter = document.getElementById('filterItemClass');
            if (!itemClassFilter) {
                console.error('    ‚úó filterItemClass element not found!');
                return;
            }
            
            const classSet = new Set();
            gameItems.forEach(item => {
                if (item.classes) {
                    try {
                        const classes = JSON.parse(item.classes);
                        classes.forEach(cls => classSet.add(cls));
                    } catch (e) {
                        console.error('    ‚úó Error parsing classes:', item.id, e);
                    }
                }
            });
            
            itemClassFilter.innerHTML = '<option value="">Any Class</option>';
            
            Array.from(classSet).sort().forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls === 'any' ? 'Any Class (Universal)' : cls.charAt(0).toUpperCase() + cls.slice(1);
                itemClassFilter.appendChild(option);
            });
            
            console.log('    ‚úì Class filter:', classSet.size, 'classes -', Array.from(classSet).join(', '));
        }
        
        // Populate extra property filter
        function populateExtraPropertyFilter() {
            console.log('    ‚Üí Populating Extra Property filter...');
            
            const extraFilter = document.getElementById('filterExtraProperty');
            if (!extraFilter) {
                console.error('    ‚úó filterExtraProperty element not found!');
                return;
            }
            
            const extraSet = new Set();
            gameItems.forEach(item => {
                if (item.extra) {
                    item.extra.split(',').forEach(extra => {
                        const trimmed = extra.trim();
                        if (trimmed) extraSet.add(trimmed);
                    });
                }
            });
            
            extraFilter.innerHTML = '<option value="">Any</option>';
            
            Array.from(extraSet).sort().forEach(extra => {
                const option = document.createElement('option');
                option.value = extra;
                option.textContent = extra;
                extraFilter.appendChild(option);
            });
            
            console.log('    ‚úì Extra Property filter:', extraSet.size, 'properties -', Array.from(extraSet).join(', '));
        }
        
        // Populate all filters from game items
        function populateFilters() {
            console.log('  ‚Üí populateFilters called');
            
            if (!gameItems || gameItems.length === 0) {
                console.error('  ‚úó Cannot populate filters - gameItems is null or empty!');
                return false;
            }
            
            console.log('  ‚Üí gameItems available:', gameItems.length, 'items');
            
            populateItemNameFilter();
            populateItemClassFilter();
            populateExtraPropertyFilter();
            
            return true;
        }
        
        async function loadAllListings() {
            console.log('  ‚Üí Starting to load all listings...');
            
            const listings = document.getElementById('listings');
            document.getElementById('statusText').textContent = 'Loading';
            listings.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading all market listings...</p></div>';
            
            allListings = [];
            let page = 1;
            let hasMore = true;
            
            try {
                while (hasMore) {
                    console.log(`  ‚Üí Fetching page ${page}...`);
                    document.getElementById('statusText').textContent = `Loading page ${page}...`;
                    
                    const params = new URLSearchParams();
                    params.append('page', page);
                    
                    const response = await fetch(`/api/listings?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log(`  ‚Üí Page ${page} response:`, data.status, `(${data.listings?.length || 0} items)`);
                    
                    if (data.status === 'error') {
                        throw new Error(data.message || 'API returned error status');
                    }
                    
                    if (data.listings && data.listings.length > 0) {
                        allListings = allListings.concat(data.listings);
                        document.getElementById('totalCount').textContent = allListings.length;
                    }
                    
                    // Check if there's a next page
                    hasMore = data.next_page === true || data.next_page === 'true';
                    console.log(`  ‚Üí Page ${page} complete. Next page: ${hasMore}`);
                    page++;
                    
                    // Safety limit to prevent infinite loops
                    if (page > 100) {
                        console.warn('  ‚ö† Reached page limit of 100');
                        break;
                    }
                }
                
                console.log('  ‚úì All listings loaded:', allListings.length, 'total');
                document.getElementById('statusText').textContent = 'Ready';
                document.getElementById('totalCount').textContent = allListings.length;
                
                // Apply filters to show all listings
                applyFilters();
                
            } catch (error) {
                console.error('  ‚úó ERROR loading listings:', error);
                listings.innerHTML = `<div class="error"><h3>Error Loading Listings</h3><p>${error.message}</p></div>`;
                document.getElementById('statusText').textContent = 'Error';
                throw error; // Re-throw so the main initialization catches it
            }
        }
        
        function applyFilters() {
            if (!allListings || allListings.length === 0) {
                return;
            }
            
            // Get filter values
            const usernameFilter = document.getElementById('filterUsername').value.toLowerCase().trim();
            const minPower = parseFloat(document.getElementById('filterMinPower').value) || 0;
            const maxPower = parseFloat(document.getElementById('filterMaxPower').value) || 999;
            const minRange = parseInt(document.getElementById('filterMinRange').value);
            const maxRange = parseInt(document.getElementById('filterMaxRange').value);
            const maxPlatinum = parseInt(document.getElementById('filterMaxPlatinum').value);
            const maxGold = parseInt(document.getElementById('filterMaxGold').value);
            const maxGems = parseInt(document.getElementById('filterMaxGems').value);
            const itemNameFilter = document.getElementById('filterItemName').value;
            const slotFilter = document.getElementById('filterSlot').value;
            const itemClassFilter = document.getElementById('filterItemClass').value.toLowerCase();
            const extraPropertyFilter = document.getElementById('filterExtraProperty').value;
            
            // Filter the listings
            let filteredListings = allListings.filter(item => {
                // Username filter
                if (usernameFilter && !item.username.toLowerCase().includes(usernameFilter)) {
                    return false;
                }
                
                // Slot filter
                if (slotFilter && item.slot !== slotFilter) {
                    return false;
                }
                
                // Power filter (convert to percentage)
                const powerPercent = parseFloat(item.power) * 100;
                if (powerPercent < minPower || powerPercent > maxPower) {
                    return false;
                }
                
                // Range filter
                if (!isNaN(minRange) || !isNaN(maxRange)) {
                    let itemRange = null;
                    try {
                        const extras = JSON.parse(item.extra || '{}');
                        itemRange = extras.range;
                    } catch (e) {}
                    
                    if (itemRange === null) {
                        // Item has no range, skip if we're filtering by range
                        if (!isNaN(minRange) || !isNaN(maxRange)) {
                            return false;
                        }
                    } else {
                        if (!isNaN(minRange) && itemRange < minRange) return false;
                        if (!isNaN(maxRange) && itemRange > maxRange) return false;
                    }
                }
                
                // Currency filters
                if (!isNaN(maxPlatinum)) {
                    const platinumCost = parseInt(item.platinum_cost) || 0;
                    if (platinumCost > maxPlatinum) return false;
                }
                
                if (!isNaN(maxGold)) {
                    const goldCost = parseInt(item.gold_cost) || 0;
                    if (goldCost > maxGold) return false;
                }
                
                if (!isNaN(maxGems)) {
                    const gemCost = parseInt(item.gem_cost) || 0;
                    if (gemCost > maxGems) return false;
                }
                
                // Item name filter
                if (itemNameFilter) {
                    const [filterId, filterSlot] = itemNameFilter.split(':');
                    if (item.base_item_id !== filterId || item.slot !== filterSlot) {
                        return false;
                    }
                }
                
                // Item class filter - items with "any" class can be worn by anyone
                if (itemClassFilter && gameItems) {
                    const gameItem = gameItems.find(gi => gi.id === item.base_item_id && gi.slot === item.slot);
                    if (gameItem && gameItem.classes) {
                        try {
                            const classes = JSON.parse(gameItem.classes);
                            // Show items that either match the selected class OR have "any" class
                            if (!classes.includes(itemClassFilter) && !classes.includes('any')) {
                                return false;
                            }
                        } catch (e) {
                            return false;
                        }
                    }
                }
                
                // Extra property filter
                if (extraPropertyFilter) {
                    let hasProperty = false;
                    try {
                        const extras = JSON.parse(item.extra || '{}');
                        // Check if the extra property matches
                        if (extras.extra === extraPropertyFilter) {
                            hasProperty = true;
                        }
                    } catch (e) {}
                    
                    // Also check game item's extra field
                    if (!hasProperty && gameItems) {
                        const gameItem = gameItems.find(gi => gi.id === item.base_item_id && gi.slot === item.slot);
                        if (gameItem && gameItem.extra) {
                            const extraProps = gameItem.extra.split(',').map(e => e.trim());
                            hasProperty = extraProps.includes(extraPropertyFilter);
                        }
                    }
                    
                    if (!hasProperty) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Update showing count
            document.getElementById('showingCount').textContent = filteredListings.length;
            
            // Render filtered listings
            renderListings({ listings: filteredListings });
        }
        
        function clearFilters() {
            document.getElementById('filterUsername').value = '';
            document.getElementById('filterMinPower').value = '';
            document.getElementById('filterMaxPower').value = '';
            document.getElementById('filterMinRange').value = '';
            document.getElementById('filterMaxRange').value = '';
            document.getElementById('filterMaxPlatinum').value = '';
            document.getElementById('filterMaxGold').value = '';
            document.getElementById('filterMaxGems').value = '';
            document.getElementById('filterItemName').value = '';
            document.getElementById('filterSlot').value = '';
            document.getElementById('filterItemClass').value = '';
            document.getElementById('filterExtraProperty').value = '';
            applyFilters();
        }
        
        function getItemName(baseItemId, slot) {
            if (!gameItems) return null;
            
            const item = gameItems.find(i => i.id === baseItemId && i.slot === slot);
            return item ? item.item_name : null;
        }
        
        function renderListings(data) {
            const listings = document.getElementById('listings');
            
            if (!data.listings || data.listings.length === 0) {
                listings.innerHTML = '<div class="loading"><p>No listings found</p></div>';
                return;
            }
            
            listings.innerHTML = '';
            
            data.listings.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'listing-card';
                card.style.setProperty('--index', index + 1);
                
                // Parse extra field if it exists
                let extras = {};
                let rangeValue = null;
                let attributeType = null;
                
                if (item.extra) {
                    try {
                        extras = JSON.parse(item.extra);
                        if (extras.range) rangeValue = extras.range;
                        if (extras.extra) attributeType = extras.extra;
                    } catch (e) {
                        // Invalid JSON, ignore
                    }
                }
                
                // Determine what the power represents based on slot
                let powerType;
                switch(item.slot) {
                    case 'weapon':
                        powerType = 'Damage';
                        break;
                    case 'head':
                        powerType = 'HP';
                        break;
                    case 'hands':
                        powerType = 'Attack Speed';
                        break;
                    case 'body':
                        powerType = 'HP';
                        break;
                    case 'feet':
                        powerType = 'Movement Speed';
                        break;
                    case 'neck':
                        powerType = attributeType || 'Placeholder';
                        break;
                    case 'ring':
                        powerType = attributeType || 'Stat';
                        break;
                    case 'off_hand':
                        powerType = attributeType || 'Stat';
                        break;
                    default:
                        powerType = attributeType || 'Power';
                }
                
                // Add range to power label if exists
                let powerLabel = powerType;
                if (rangeValue) {
                    powerLabel += ` (Range ${rangeValue})`;
                }
                
                let powerPercent = (parseFloat(item.power) * 100).toFixed(1);
                
                // Get item name from game items data
                const itemName = getItemName(item.base_item_id, item.slot);
                const itemNameDisplay = itemName ? `<div class="item-name">${escapeHtml(itemName)}</div>` : '';
                
                // Format costs properly - can have multiple currencies
                const platinum = parseInt(item.platinum_cost) || 0;
                const gold = parseInt(item.gold_cost) || 0;
                const gem = parseInt(item.gem_cost) || 0;
                
                let costDisplay = [];
                if (platinum > 0) costDisplay.push(`<div class="cost-line"><span class="cost-icon" style="color: #a8dadc;">üíé</span><span>${platinum.toLocaleString()} platinum</span></div>`);
                if (gold > 0) costDisplay.push(`<div class="cost-line"><span class="cost-icon" style="color: var(--accent-gold);">ü™ô</span><span>${gold.toLocaleString()} gold</span></div>`);
                if (gem > 0) costDisplay.push(`<div class="cost-line"><span class="cost-icon" style="color: #c084fc;">üíé</span><span>${gem.toLocaleString()} gems</span></div>`);
                
                const costHTML = costDisplay.length > 0 ? costDisplay.join('') : '<div class="cost-line" style="color: var(--text-muted);">Free</div>';
                
                card.innerHTML = `
                    <div class="card-id">#${item.id}</div>
                    <div class="card-user">
                        <div class="username">${escapeHtml(item.username)}</div>
                        ${itemNameDisplay}
                        <div class="item-type">${escapeHtml(item.slot)}</div>
                    </div>
                    <div class="card-slot">
                        <div class="slot-icon">${slotIcons[item.slot] || 'üì¶'}</div>
                        <span class="slot-name">${formatSlotName(item.slot)}</span>
                    </div>
                    <div class="card-power">
                        <div class="power-label">${powerLabel}</div>
                        <div class="power-value">${powerPercent}%</div>
                    </div>
                    <div class="card-costs">
                        ${costHTML}
                    </div>
                    <div class="card-dates">
                        <div class="date-row">
                            <span class="date-label">Created:</span>
                            <span class="date-value">${formatDate(item.time_created)}</span>
                        </div>
                        <div class="date-row">
                            <span class="date-label">Expires:</span>
                            <span class="date-value">${formatDate(item.time_expires)}</span>
                        </div>
                    </div>
                `;
                
                listings.appendChild(card);
            });
        }
        
        function formatSlotName(slot) {
            if (!slot) return 'Unknown';
            return slot.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return dateStr.substring(0, 16).replace('T', ' ');
        }
        
        function getTagIcon(key) {
            const icons = {
                'Damage': '‚öîÔ∏è',
                'damage': '‚öîÔ∏è',
                'Mana': '‚ú®',
                'mana': '‚ú®',
                'Health': '‚ù§Ô∏è',
                'health': '‚ù§Ô∏è',
                'Defense': 'üõ°Ô∏è',
                'defense': 'üõ°Ô∏è',
                'Speed': '‚ö°',
                'speed': '‚ö°'
            };
            return icons[key] || '‚ú®';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        
        // Load on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== Page Initialization Started ===');
            
            try {
                // STEP 1: Load game items and WAIT for completion
                console.log('STEP 1: Loading game items...');
                await loadGameItems();
                
                if (!gameItems || gameItems.length === 0) {
                    console.error('CRITICAL ERROR: Game items failed to load!');
                    document.getElementById('statusText').textContent = 'Error: Game items failed to load';
                    return;
                }
                
                console.log('‚úì STEP 1 COMPLETE: Game items loaded successfully');
                console.log('  Total items:', gameItems.length);
                
                // STEP 2: Populate all filters
                console.log('STEP 2: Populating filters...');
                populateFilters();
                console.log('‚úì STEP 2 COMPLETE: Filters populated');
                
                // STEP 3: Setup event listeners
                console.log('STEP 3: Setting up event listeners...');
                setupEventListeners();
                console.log('‚úì STEP 3 COMPLETE: Event listeners ready');
                
                // STEP 4: Load all listings
                console.log('STEP 4: Loading all market listings...');
                await loadAllListings();
                console.log('‚úì STEP 4 COMPLETE: All listings loaded');
                
                console.log('=== Initialization Complete ===');
                
            } catch (error) {
                console.error('FATAL ERROR during initialization:', error);
                document.getElementById('statusText').textContent = 'Fatal Error';
            }
        });
    </script>
</body>
</html>
